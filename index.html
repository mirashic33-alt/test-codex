<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MP3 Player • Dab‑Dab (Dual Viz)</title>
<style>
  :root{
    --bg:#0b0f14;
    --panel:#121922;
    --text:#e6eef5;
    --muted:#8aa0b7;
    --accent:#ff9d2d;
    --ring:#2a3a4b;
    --radius:28px;
    --pad:14px;
    --pulse: 0.12;
    --pulse-boost: 2.1;
    --pulse-floor: 0.22;
    --hue: 32;
    --bar-hue: 35;
  }
  html, body {height: 100%;}
  body{
    margin:0;
    background:
      radial-gradient(1200px 500px at 50% 120%, #1a2632 0%, transparent 60%),
      radial-gradient(900px 400px at 50% -10%, #081018 0%, transparent 60%),
      var(--bg);
    color:var(--text);
    font:500 15px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display:flex; align-items:center; justify-content:center;
    padding:env(safe-area-inset-top) var(--pad) var(--pad);
    min-height:100svh;
  }
  .phone{
    width:min(420px, 94vw); margin-inline:auto;
    background: linear-gradient(180deg, #0e151d 0%, #0b1118 100%);
    border-radius:calc(var(--radius) + 4px);
    box-shadow:
      0 0 0 1px rgba(18,214,255,.07) inset,
      0 0 0 2px rgba(255,157,45,.06) inset,
      0 30px 70px rgba(0,0,0,.65),
      0 0 60px rgba(255,157,45,.16);
    overflow:hidden; position:relative;
    max-height:calc(100svh - 2*var(--pad));
  }
  .bezel{ padding:14px 14px 10px; }
  .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .modes{
    position:relative;
    display:flex; gap:6px; background:var(--panel); padding:6px; border-radius:999px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);
  }
  .modes span{ font-size:12px; letter-spacing:.04em; padding:6px 9px; border-radius:999px;
               color:var(--muted); background:transparent; cursor:pointer; user-select:none; }
  .modes span.active{ color:#101318; font-weight:700; background:linear-gradient(180deg, #ffb25e, #ff9229);
                      box-shadow:0 0 18px rgba(255,157,45,.45); }

  .panel{ position:relative; }
  .panel .track-title{
    position:absolute; top:6px; left:50%; transform:translateX(-50%); z-index:3; margin:0;
    font-size:13px; letter-spacing:.02em; color:rgba(234,244,255,.72); pointer-events:none;
    width: calc(100% - 32px); text-align:center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .dial-wrap{ display:grid; place-items:center; margin:6px 0 6px; }
  .dial{
    width:min(50vw, 160px); height:min(50vw, 160px);
    border-radius:50%; position:relative;
    background: radial-gradient(60% 60% at 50% 50%, #0f141b 35%, #0a0f16 75%),
               conic-gradient(from 0deg at 50% 50%, rgba(255,157,45,.00) 0 74%,
               rgba(255,157,45,.60) 78%, rgba(255,157,45,.00) 84%, rgba(255,157,45,.00) 100%);
    box-shadow: inset 0 0 40px rgba(0,0,0,.7), 0 0 60px rgba(255,157,45,.16);
    filter: drop-shadow(0 0 calc(26px + 80px * var(--pulse)) hsla(var(--hue), 100%, 55%, 0.24));
    transition: filter .08s linear;
  }
  .dial::before, .dial::after{ content:""; position:absolute; inset:10px; border-radius:50%;
    border:1px solid var(--ring); box-shadow:0 0 0 2px rgba(18,214,255,.05) inset; }
  .dial::after{ inset:22px; border:1px dashed rgba(255,157,45,.25); animation:spin 14s linear infinite; }
  .core{ position:absolute; inset:38px; border-radius:50%;
         background:radial-gradient(60% 60% at 50% 50%, #0b1219, #05090f);
         box-shadow:inset 0 0 0 1px rgba(255,255,255,.05), 0 0 40px rgba(18,214,255,.18); }
  @keyframes spin{ to{ transform:rotate(360deg)} }

  .panel{
    background:linear-gradient(180deg, #0c121a 0%, #0a1017 100%);
    border-radius:18px; padding:10px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), inset 0 -50px 120px rgba(0,0,0,.55);
  }
  .grid{ position:absolute; inset:10px; border-radius:12px; pointer-events:none;
     background: linear-gradient(to top, rgba(255,157,45,.14), rgba(255,157,45,.00)),
     repeating-linear-gradient(to right, rgba(255,255,255,.05) 0 1px, transparent 1px 10px),
     repeating-linear-gradient(to top, rgba(255,255,255,.05) 0 1px, transparent 1px 24px);
     opacity:.55; }
  .viz{ --bars:48; height:min(26svh, 160px); display:flex; align-items:flex-end; gap:4px; position:relative; z-index:1; }
  @supports not (height: 26svh){ .viz{ height:min(26vh, 160px);} }
  
  .bar{
    width: calc((100% - (var(--bars) - 1)*4px)/var(--bars)); height: 20%;
    background: linear-gradient(to top, hsl(var(--bar-hue, 35), 95%, 60%) 0%, hsl(var(--bar-hue, 35), 85%, 70%, 0.25) 70%, transparent 100%);
    border-radius:6px;
    box-shadow: 0 0 10px hsl(var(--bar-hue, 35), 95%, 60%, 0.25), 0 6px 18px hsl(var(--bar-hue, 35), 95%, 60%, 0.15);
    transform-origin: bottom center;
    transition: background .3s, box-shadow .3s;
  }

  .seek{
    -webkit-appearance: none; appearance: none; width: 100%; height: 4px;
    background: rgba(255,157,45,.25); border-radius: 999px; outline: none;
    margin: 6px 0 2px; position: relative;
  }
  .seek[disabled]{ opacity:.35; }
  .seek::-webkit-slider-runnable-track{ height: 4px; background: linear-gradient(to right, #ff9d2d 0 0) no-repeat; border-radius: 999px; }
  .seek::-webkit-slider-thumb{
    -webkit-appearance: none; appearance: none; width: 14px; height: 14px; border-radius: 50%;
    background: #ff9d2d; box-shadow: 0 0 12px rgba(255,157,45,.6); margin-top: -5px;
  }
  .seek::-moz-range-track{ height:4px; background: rgba(255,157,45,.25); border-radius: 999px; }
  .seek::-moz-range-progress{ height:4px; background:#ff9d2d; border-radius: 999px; }
  .seek::-moz-range-thumb{
    width:14px; height:14px; border-radius:50%; background:#ff9d2d;
    box-shadow:0 0 12px rgba(255,157,45,.6); border: none;
  }

  .time{ display:flex; justify-content:space-between; margin-top:6px; color:var(--muted); font-size:12px; }
  .controls{ display:flex; justify-content:center; align-items:center; gap:14px; margin:10px 0 4px; }
  .btn{
    width:52px; height:52px; border-radius:50%;
    display:grid; place-items:center; cursor:pointer;
    background:linear-gradient(180deg, #1b2530, #151d27);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), 0 0 0 3px rgba(255,157,45,.08),
               0 12px 26px rgba(0,0,0,.55);
    transition:transform .08s ease; user-select:none; color:var(--text); font-size:20px;
  }
  .btn.disabled{ opacity:.4; cursor:not-allowed; }
  .btn:active{ transform:scale(.98) }
  .btn.primary{
    width:62px; height:62px; color:#0c1118; font-weight:800; font-size:20px;
    background:linear-gradient(180deg, #ffb25e, #ff9229);
    box-shadow:0 0 30px rgba(255,157,45,.45), 0 14px 26px rgba(0,0,0,.5);
  }
  .file-btn{ padding:0 14px; min-width:90px; height:38px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; gap:8px; font-size:14px; background:#17212b; color:#cfe6ff; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06); }
  .hidden-input{ position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0 0 0 0); }
  .nav{ display:flex; justify-content:space-between; align-items:center; padding:8px 2px 4px; color:var(--muted); font-size:12px; }
  .dots{ display:flex; gap:8px } .dot-sm{ width:6px; height:6px; border-radius:50%; background:#516477; opacity:.35; } .dot-sm.active{ background:var(--accent); opacity:1; box-shadow:0 0 12px rgba(255,157,45,.6) }
  @media (max-width:360px){ .btn{ width:48px; height:48px } .btn.primary{ width:58px; height:58px } }

  .dropdown{
    position:absolute; top:100%; left:0;
    margin-top:10px;
    background:#101821;
    border-radius:14px;
    box-shadow:0 16px 40px rgba(0,0,0,.65), inset 0 0 0 1px rgba(255,255,255,.06);
    display:none; flex-direction:column;
    min-width:260px; max-width:calc(94vw - 28px);
    max-height:300px; overflow:auto; -webkit-overflow-scrolling:touch;
    z-index:999;
  }
  .dropdown.open{ display:flex; }
  .station-item{
    padding:10px 14px; text-align:left; background:none; border:none; cursor:pointer;
    color:var(--text); font-size:14px; line-height:1.25; display:block;
  }
  .station-item:hover{ background:rgba(255,157,45,.12); }
  .station-item small{ display:block; color:var(--muted); font-size:12px; opacity:.85; }

  #radioEl{ position:absolute; left:-10000px; top:-10000px; width:1px; height:1px; opacity:0; }

  /* Ring + Clock */
  .ring-eq{
    position:absolute; inset:0; border-radius:50%;
    background:
      conic-gradient(from 0deg, hsla(var(--hue),100%,55%, calc(.24 + .80*var(--pulse))) 0 2deg, transparent 2deg 7.5deg),
      radial-gradient(60% 60% at 50% 50%, #0f141b 35%, #0a0f16 75%);
    -webkit-mask: radial-gradient(circle at 50% 50%, transparent 60%, black 61%);
            mask: radial-gradient(circle at 50% 50%, transparent 60%, black 61%);
    animation: ring-rot 10s linear infinite;
    box-shadow: inset 0 0 36px rgba(0,0,0,.66);
    pointer-events:none;
  }
  @keyframes ring-rot{ to { transform:rotate(360deg);} }
  .dial .core{
    position:absolute; inset:38px; border-radius:50%;
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.06),
      0 0 calc(18px + 80px * var(--pulse)) hsla(var(--hue), 100%, 55%, .30);
    transform: scale(calc(1 + .12*var(--pulse)));
    transition: transform .08s linear, box-shadow .08s linear;
  }
  /* === ИЗМЕНЕНИЕ: Стили часов === */
  .dial-clock{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-weight:700;
    font-size: 24px; /* Крупнее */
    letter-spacing: .08em; /* Шире */
    color: var(--accent);
    opacity: 0.9;
    text-shadow: 0 0 10px rgba(255,157,45,.5), 0 0 4px rgba(0,0,0,.8);
    pointer-events:none;
    transform: translateY(-2px); /* Чуть выше */
    /* font-family: ui-monospace, 'SF Mono', 'Menlo', 'Consolas', monospace; */
  }
</style>
</head>
<body>
  <main class="phone">
    <div class="bezel">
      <div class="top">
        <div class="modes">
          <span>SMSN</span>
          <span id="sastBtn" class="active">SAST</span>
          <span>LLOW</span>

          <div id="dropdown" class="dropdown" role="menu">
            <button class="station-item" data-url="http://online.kissfm.ua/KissFM">Kiss FM <small>www.kissfm.ua</small></button>
            <button class="station-item" data-url="http://online.kissfm.ua/KissFM_Ukr">Kiss FM Ukrainian <small>www.kissfm.ua</small></button>
            <button class="station-item" data-url="http://online.kissfm.ua/KissFM_Deep">Kiss FM Deep <small>www.kissfm.ua</small></button>
            <button class="station-item" data-url="http://online.kissfm.ua/KissFM_Black">Kiss FM Black <small>www.kissfm.ua</small></button>
            <button class="station-item" data-url="http://online.kissfm.ua/KissFM_Digital">Kiss FM Digital <small>www.kissfm.ua</small></button>
            <button class="station-item" data-url="http://online.kissfm.ua/KissFM_Trendz">Kiss FM Trendz <small>www.kissfm.ua</small></button>
          </div>
        </div>
        <label class="file-btn" for="fileInput">Dab‑Dab</label>
        <input id="fileInput" class="hidden-input" type="file" accept="audio/mpeg,audio/mp3,audio/*">
      </div>

      <div class="dial-wrap">
        <div class="dial" id="dial">
          <div class="ring-eq"></div>
          <div class="core"></div>
          <div class="dial-clock" id="dialClock"></div>
        </div>
      </div>

      <section class="panel">
        <div class="grid"></div>
        <div class="track-title" id="trackTitle">Выберите MP3 (Dab‑Dab) или радиостанцию (SAST)</div>
        <div class="viz" id="viz"></div>
        <input type="range" class="seek" id="seek" min="0" step="0.1" value="0" aria-label="Позиция трека" />
        <div class="time"><span id="cur">00:00</span><span id="dur">00:00</span></div>
      </section>

      <div class="controls">
        <div class="btn" id="back" title="Назад 10с">⏪</div>
        <div class="btn primary" id="playPause" title="Play/Pause">▶</div>
        <div class="btn" id="next" title="Вперёд 10с">⏩</div>
      </div>

      <div class="nav"><div class="dots"><span class="dot-sm active"></span><span class="dot-sm"></span><span class="dot-sm"></span></div><span style="opacity:.7">v1.0 Dual-Viz</span></div>

      <audio id="audio" preload="metadata" style="display:none"></audio>
      <audio id="radioEl" preload="none" crossorigin="anonymous"></audio>
    </div>
  </main>
<script>
(() => {
  const localEl  = document.getElementById('audio');
  const radioEl  = document.getElementById('radioEl');
  const fileInput = document.getElementById('fileInput');
  const playPauseBtn  = document.getElementById('playPause');
  const backBtn  = document.getElementById('back');
  const nextBtn  = document.getElementById('next');
  const curEl    = document.getElementById('cur');
  const durEl    = document.getElementById('dur');
  const titleEl  = document.getElementById('trackTitle');
  const viz      = document.getElementById('viz');
  const seek     = document.getElementById('seek');
  const sastBtn  = document.getElementById('sastBtn');
  const dropdown = document.getElementById('dropdown');
  const dial     = document.getElementById('dial');
  const dialClock= document.getElementById('dialClock');

  let isSeeking = false;
  let isRadio   = false;

  const BAR_COUNT = 48;
  for (let i=0;i<BAR_COUNT;i++){ const b=document.createElement('div'); b.className='bar'; viz.appendChild(b); }
  const bars = Array.from(document.querySelectorAll('.bar'));
  let audioCtx, analyser, localSrcNode, radioSrcNode, dataArray, rafId;

  function ensureContext(el){
    if (!audioCtx){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.connect(audioCtx.destination);
      }catch(e){ console.warn('WebAudio недоступен:', e); }
    }
    if (!audioCtx || !el) return;
    try{
      if (el === localEl && !localSrcNode){
        localSrcNode = audioCtx.createMediaElementSource(localEl);
        localSrcNode.connect(analyser);
      } else if (el === radioEl && !radioSrcNode){
        radioSrcNode = audioCtx.createMediaElementSource(radioEl);
        radioSrcNode.connect(analyser);
      }
    }catch(e){ console.warn('WebAudio источник недоступен:', e); }
  }
  function fmt(t){ if (!isFinite(t)) return '00:00'; const m=Math.floor(t/60), s=Math.floor(t%60); return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
  function levelFromFreq(bytes){
    let sum=0; for (let i=0;i<bytes.length;i++){ const v=bytes[i]/255; sum += v*v; }
    return Math.sqrt(sum/bytes.length) || 0;
  }
  function setHue(h){ if (dial) dial.style.setProperty('--hue', h); }
  
  // === ИЗМЕНЕНИЕ: Формат времени без секунд ===
  function updateClock(){ 
    try{ 
      if(dialClock){ 
        dialClock.textContent = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }); 
      } 
    }catch(e){} 
  }
  setInterval(updateClock, 1000); 
  updateClock();

  const PULSE_BOOST = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pulse-boost')) || 2.1;
  const PULSE_FLOOR = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pulse-floor')) || 0.22;
  let uiPulse = 0;
  function setPulse(lvl){
    const curved = Math.pow(Math.min(1, Math.max(0, lvl)), 0.7);
    const boosted = Math.min(1, curved * PULSE_BOOST + PULSE_FLOOR);
    uiPulse += (boosted - uiPulse) * 0.28;
    if (dial) dial.style.setProperty('--pulse', uiPulse.toFixed(3));
  }

  function draw(){
    if (analyser){
      analyser.getByteFrequencyData(dataArray);
      const step = Math.floor(dataArray.length / BAR_COUNT);
      for (let i=0;i<BAR_COUNT;i++){
        const val = dataArray[i*step] || 0;
        const h = Math.max(8, (val/255)*100);
        bars[i].style.height = h + '%';
      }
      const lvl = levelFromFreq(dataArray);
      setPulse(lvl);
    }
    if (!isRadio){
      curEl.textContent = fmt(localEl.currentTime);
      durEl.textContent = fmt(localEl.duration);
      if (!isSeeking && isFinite(localEl.duration)) seek.value = localEl.currentTime.toFixed(1);
    } else {
      curEl.textContent = 'LIVE';
      durEl.textContent = '— —';
    }
    rafId = requestAnimationFrame(draw);
  }

  function startDraw(){ if (!rafId) rafId = requestAnimationFrame(draw); }
  function stopDraw(){ if (rafId){ cancelAnimationFrame(rafId); rafId=null; } bars.forEach(b => b.style.height='20%'); setPulse(0.12); }

  function setModeRadio(on){
    isRadio = !!on;
    seek.disabled = isRadio;
    backBtn.classList.toggle('disabled', isRadio);
    nextBtn.classList.toggle('disabled', isRadio);
    if (isRadio){ seek.value = 0; curEl.textContent='LIVE'; durEl.textContent='— —'; }
  }

  function activeEl(){ return isRadio ? radioEl : localEl; }
  playPauseBtn.addEventListener('click', async () => {
    const el = activeEl();
    if (!el.src) return;
    ensureContext(el);
    if(audioCtx) await audioCtx.resume();
    if (el.paused){ el.play().then(()=>{ playPauseBtn.textContent='⏸'; startDraw(); }).catch(()=>{}); }
    else { el.pause(); playPauseBtn.textContent='▶'; stopDraw(); }
  });
  backBtn.addEventListener('click', () => { if (!isRadio && localEl.src) localEl.currentTime = Math.max(0, localEl.currentTime - 10); });
  nextBtn.addEventListener('click', () => { if (!isRadio && localEl.src) localEl.currentTime = Math.min(localEl.duration || localEl.currentTime+10, localEl.currentTime + 10); });

  fileInput.addEventListener('change', () => {
    const file = fileInput.files && fileInput.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    localEl.src = url;
    titleEl.textContent = (file.name || 'Выбранный трек').replace(/\.(mp3|wav|ogg|m4a)$/i,'');
    localEl.load();
    setModeRadio(false);
    localEl.onloadedmetadata = () => {
      durEl.textContent = fmt(localEl.duration);
      curEl.textContent = '00:00';
      seek.max = Math.max(0, localEl.duration || 0).toFixed(1);
      seek.value = 0;
    };
    playPauseBtn.textContent = '▶';
    stopDraw();
    if (radioEl.src) { radioEl.pause(); }
  });
  localEl.addEventListener('ended', () => { playPauseBtn.textContent='▶'; stopDraw(); });

  seek.addEventListener('input', () => { isSeeking = true; });
  seek.addEventListener('change', () => {
    if (!isRadio && isFinite(localEl.duration)) { localEl.currentTime = parseFloat(seek.value) || 0; }
    isSeeking = false;
  });
  ['pointerup','mouseup','touchend','mouseleave'].forEach(ev => document.addEventListener(ev, () => isSeeking = false, {passive:true}));

  function toggleDropdown(force){
    const open = force !== undefined ? force : !dropdown.classList.contains('open');
    dropdown.classList.toggle('open', open);
    if (open){
      const r = dropdown.getBoundingClientRect();
      const phone = document.querySelector('.phone').getBoundingClientRect();
      if (r.right > phone.right){
        const shift = r.right - phone.right + 8;
        dropdown.style.left = `-${shift}px`;
      } else {
        dropdown.style.left = '0';
      }
    }
  }
  sastBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleDropdown(); });
  document.addEventListener('click', (e)=>{
    if (!dropdown.contains(e.target) && e.target !== sastBtn) toggleDropdown(false);
  });
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') toggleDropdown(false); });

    dropdown.querySelectorAll('.station-item').forEach(btn => {
      btn.addEventListener('click', async () => {
        const url = btn.dataset.url;
        const name = btn.childNodes[0].textContent.trim();

        setModeRadio(true);
        titleEl.textContent = name + ' • LIVE';
        if (localEl.src){ localEl.pause(); }
        radioEl.src = url;
        ensureContext(radioEl);
        try{ if(audioCtx) await audioCtx.resume(); }catch(e){}
        radioEl.play().then(()=>{
          playPauseBtn.textContent='⏸'; startDraw();
        }).catch(err=>{
          console.warn('Не удалось начать воспроизведение:', err);
          playPauseBtn.textContent='▶';
        });
        toggleDropdown(false);
      });
    });
})();
</script>
</body>
</html>
